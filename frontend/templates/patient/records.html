{% extends "base.html" %}

{% block title %}Hồ sơ bệnh án - Bệnh nhân{% endblock %}

{% block page_title %}Hồ sơ bệnh án{% endblock %}

{% block sidebar_menu %}
<a href="{{ url_for('patient.dashboard') }}" class="nav-link">
    <i class="fas fa-home"></i>
    <span>Trang chủ</span>
</a>
<a href="{{ url_for('patient.appointments') }}" class="nav-link">
    <i class="fas fa-calendar-alt"></i>
    <span>Lịch hẹn</span>
</a>
<a href="{{ url_for('patient.records') }}" class="nav-link">
    <i class="fas fa-file-medical"></i>
    <span>Hồ sơ bệnh án</span>
</a>
<a href="{{ url_for('patient.prescriptions') }}" class="nav-link">
    <i class="fas fa-prescription"></i>
    <span>Đơn thuốc</span>
</a>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Medical History Timeline -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-history me-2"></i>
                    Lịch sử khám bệnh
                </h2>
            </div>
            <div class="card-body">
                <div class="medical-timeline">
                    {% for record in medical_records %}
                    <div class="timeline-item">
                        <div class="timeline-marker {{ record.status_color }}">
                            <i class="fas fa-circle"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="card">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="date">
                                            <i class="fas fa-calendar me-2"></i>
                                            {{ record.date }}
                                        </span>
                                        <span class="department text-muted">
                                            {{ record.department }}
                                        </span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <h5 class="doctor-name mb-3">
                                        <i class="fas fa-user-md me-2"></i>
                                        Bác sĩ {{ record.doctor_name }}
                                    </h5>
                                    
                                    <div class="diagnosis-section mb-3">
                                        <h6 class="text-primary">Chẩn đoán</h6>
                                        <p>{{ record.diagnosis }}</p>
                                    </div>

                                    {% if record.symptoms %}
                                    <div class="symptoms-section mb-3">
                                        <h6 class="text-primary">Triệu chứng</h6>
                                        <p>{{ record.symptoms }}</p>
                                    </div>
                                    {% endif %}

                                    {% if record.notes %}
                                    <div class="notes-section mb-3">
                                        <h6 class="text-primary">Ghi chú</h6>
                                        <p>{{ record.notes }}</p>
                                    </div>
                                    {% endif %}

                                    {% if record.has_prescription %}
                                    <div class="prescription-section">
                                        <h6 class="text-primary">Đơn thuốc</h6>
                                        <div class="table-container">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th>Thuốc</th>
                                                        <th>Liều lượng</th>
                                                        <th>Tần suất</th>
                                                        <th>Thời gian</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for medicine in record.prescription %}
                                                    <tr>
                                                        <td>{{ medicine.name }}</td>
                                                        <td>{{ medicine.dosage }}</td>
                                                        <td>{{ medicine.frequency }}</td>
                                                        <td>{{ medicine.duration }}</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    {% endif %}

                                    {% if record.test_results %}
                                    <div class="test-results mt-3">
                                        <h6 class="text-primary">Kết quả xét nghiệm</h6>
                                        <div class="row">
                                            {% for test in record.test_results %}
                                            <div class="col-md-6 mb-3">
                                                <div class="test-result-item">
                                                    <h6>{{ test.name }}</h6>
                                                    <p>{{ test.result }}</p>
                                                    {% if test.file_url %}
                                                    <a href="{{ test.file_url }}" 
                                                       class="btn btn-sm btn-outline-primary"
                                                       target="_blank">
                                                        <i class="fas fa-download me-1"></i>
                                                        Tải kết quả
                                                    </a>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Medical Summary -->
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-notes-medical me-2"></i>
                    Tổng quan
                </h2>
            </div>
            <div class="card-body">
                {% if medical_summary %}
                <div class="medical-summary">
                    {% if medical_summary.allergies %}
                    <div class="mb-3">
                        <h6 class="text-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Dị ứng
                        </h6>
                        <ul class="list-unstyled">
                            {% for allergy in medical_summary.allergies %}
                            <li>{{ allergy }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if medical_summary.chronic_conditions %}
                    <div class="mb-3">
                        <h6 class="text-warning">
                            <i class="fas fa-heartbeat me-2"></i>
                            Bệnh mãn tính
                        </h6>
                        <ul class="list-unstyled">
                            {% for condition in medical_summary.chronic_conditions %}
                            <li>{{ condition }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if medical_summary.surgeries %}
                    <div class="mb-3">
                        <h6>
                            <i class="fas fa-hospital me-2"></i>
                            Tiền sử phẫu thuật
                        </h6>
                        <ul class="list-unstyled">
                            {% for surgery in medical_summary.surgeries %}
                            <li>
                                <strong>{{ surgery.date }}</strong>
                                <p>{{ surgery.procedure }}</p>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <p class="text-muted">Chưa có thông tin tổng quan</p>
                {% endif %}
            </div>
        </div>

        <!-- Health Metrics -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-chart-line me-2"></i>
                    Chỉ số sức khỏe
                </h2>
            </div>
            <div class="card-body">
                {% if health_metrics %}
                <div class="health-metrics">
                    <div class="metric-item mb-3">
                        <label>Huyết áp</label>
                        <div class="d-flex justify-content-between">
                            <span>{{ health_metrics.blood_pressure }}</span>
                            <small class="text-muted">{{ health_metrics.blood_pressure_date }}</small>
                        </div>
                    </div>
                    <div class="metric-item mb-3">
                        <label>Nhịp tim</label>
                        <div class="d-flex justify-content-between">
                            <span>{{ health_metrics.heart_rate }} BPM</span>
                            <small class="text-muted">{{ health_metrics.heart_rate_date }}</small>
                        </div>
                    </div>
                    <div class="metric-item mb-3">
                        <label>Cân nặng</label>
                        <div class="d-flex justify-content-between">
                            <span>{{ health_metrics.weight }} kg</span>
                            <small class="text-muted">{{ health_metrics.weight_date }}</small>
                        </div>
                    </div>
                    <div class="metric-item">
                        <label>Chiều cao</label>
                        <div class="d-flex justify-content-between">
                            <span>{{ health_metrics.height }} cm</span>
                            <small class="text-muted">{{ health_metrics.height_date }}</small>
                        </div>
                    </div>
                </div>
                {% else %}
                <p class="text-muted">Chưa có dữ liệu chỉ số sức khỏe</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.medical-timeline {
    position: relative;
    padding: 2rem 0;
}

.timeline-item {
    position: relative;
    padding-left: 3rem;
    margin-bottom: 2rem;
}

.timeline-marker {
    position: absolute;
    left: 0;
    top: 0;
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    background: var(--white);
    border: 2px solid var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
}

.timeline-marker i {
    font-size: 0.8rem;
    color: var(--primary);
}

.timeline-content {
    position: relative;
}

.timeline-content::before {
    content: '';
    position: absolute;
    left: -2rem;
    top: 1rem;
    width: 2rem;
    height: 2px;
    background: var(--gray-300);
}

.timeline-item:not(:last-child)::after {
    content: '';
    position: absolute;
    left: 1rem;
    top: 2rem;
    bottom: -2rem;
    width: 2px;
    background: var(--gray-300);
}

.metric-item label {
    font-weight: 500;
    color: var(--text);
    margin-bottom: 0.25rem;
}

.test-result-item {
    padding: 1rem;
    border: 1px solid var(--gray-200);
    border-radius: var(--border-radius-md);
}

.test-result-item h6 {
    margin-bottom: 0.5rem;
    color: var(--text);
}
</style>
{% endblock %}