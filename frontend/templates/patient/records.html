{% extends "base.html" %}

{% block title %}Hồ sơ bệnh án - Bệnh nhân{% endblock %}

{% block page_title %}Hồ sơ bệnh án{% endblock %}

{% block sidebar_menu %}
<a href="{{ url_for('patient.dashboard') }}" class="nav-link">
    <i class="fas fa-home"></i>
    <span>Trang chủ</span>
</a>
<a href="{{ url_for('patient.appointments') }}" class="nav-link">
    <i class="fas fa-calendar-alt"></i>
    <span>Lịch hẹn</span>
</a>
<a href="{{ url_for('patient.records') }}" class="nav-link">
    <i class="fas fa-file-medical"></i>
    <span>Hồ sơ bệnh án</span>
</a>
<a href="{{ url_for('patient.prescriptions') }}" class="nav-link">
    <i class="fas fa-prescription"></i>
    <span>Đơn thuốc</span>
</a>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Medical History Timeline -->
    <div class="card">
        <div class="card-body">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Ngày khám</th>
                            <th>Mã BN</th>
                            <th>Họ và tên</th>
                            <th>Triệu chứng</th>
                            <th>Chẩn đoán</th>
                            <th>Tái khám</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in medical_records %}
                        <tr>
                            <td>{{ record.visitDate }}</td>
                            <td>{{ record.patientId }}</td>
                            <td>{{ record.patient_name }}</td>
                            <td>{{ record.symptoms }}</td>
                            <td>{{ record.diagnosis }}</td>
                            <td>
                                {% if record.followUp.required %}
                                <span class="badge badge-warning">
                                    {{ record.followUp.recommendedDate }}
                                </span>
                                {% else %}
                                <span class="badge badge-secondary">Không</span>
                                {% endif %}
                            </td>
                            <td>
                                <button type="button" 
                                        class="btn btn-primary btn-sm" 
                                        onclick="viewRecord('{{ record._id }}')">
                                    <i class="fas fa-eye"></i> 
                                    Xem
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
    
    <!-- Medical Summary -->
    <!--<div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-notes-medical me-2"></i>
                    Tổng quan
                </h2>
            </div>
            <div class="card-body">
                {% if medical_summary %}
                <div class="medical-summary">
                    {% if medical_summary.allergies %}
                    <div class="mb-3">
                        <h6 class="text-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Dị ứng
                        </h6>
                        <ul class="list-unstyled">
                            {% for allergy in medical_summary.allergies %}
                            <li>{{ allergy }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if medical_summary.chronic_conditions %}
                    <div class="mb-3">
                        <h6 class="text-warning">
                            <i class="fas fa-heartbeat me-2"></i>
                            Bệnh mãn tính
                        </h6>
                        <ul class="list-unstyled">
                            {% for condition in medical_summary.chronic_conditions %}
                            <li>{{ condition }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if medical_summary.surgeries %}
                    <div class="mb-3">
                        <h6>
                            <i class="fas fa-hospital me-2"></i>
                            Tiền sử phẫu thuật
                        </h6>
                        <ul class="list-unstyled">
                            {% for surgery in medical_summary.surgeries %}
                            <li>
                                <strong>{{ surgery.date }}</strong>
                                <p>{{ surgery.procedure }}</p>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <p class="text-muted">Chưa có thông tin tổng quan</p>
                {% endif %}
            </div>
        </div>-->

        <!-- Health Metrics -->
        <!--<div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-chart-line me-2"></i>
                    Chỉ số sức khỏe
                </h2>
            </div>
            <div class="card-body">
                {% if health_metrics %}
                <div class="health-metrics">
                    <div class="metric-item mb-3">
                        <label>Huyết áp</label>
                        <div class="d-flex justify-content-between">
                            <span>{{ health_metrics.blood_pressure }}</span>
                            <small class="text-muted">{{ health_metrics.blood_pressure_date }}</small>
                        </div>
                    </div>
                    <div class="metric-item mb-3">
                        <label>Nhịp tim</label>
                        <div class="d-flex justify-content-between">
                            <span>{{ health_metrics.heart_rate }} BPM</span>
                            <small class="text-muted">{{ health_metrics.heart_rate_date }}</small>
                        </div>
                    </div>
                    <div class="metric-item mb-3">
                        <label>Cân nặng</label>
                        <div class="d-flex justify-content-between">
                            <span>{{ health_metrics.weight }} kg</span>
                            <small class="text-muted">{{ health_metrics.weight_date }}</small>
                        </div>
                    </div>
                    <div class="metric-item">
                        <label>Chiều cao</label>
                        <div class="d-flex justify-content-between">
                            <span>{{ health_metrics.height }} cm</span>
                            <small class="text-muted">{{ health_metrics.height_date }}</small>
                        </div>
                    </div>
                </div>
                {% else %}
                <p class="text-muted">Chưa có dữ liệu chỉ số sức khỏe</p>
                {% endif %}
            </div>
        </div>-->
<!-- View Record Modal -->
<div class="modal" id="viewRecordModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết hồ sơ bệnh án</h5>
                <button type="button" class="btn-close" onclick="closeModal()"></button>
            </div>
            <div class="modal-body" id="recordDetails">
                <!-- Record details will be injected here -->
            </div>
        </div>
    </div>
</div>

    </div>
</div>

<style>
.medical-timeline {
    position: relative;
    padding: 2rem 0;
}

.timeline-item {
    position: relative;
    padding-left: 3rem;
    margin-bottom: 2rem;
}

.timeline-marker {
    position: absolute;
    left: 0;
    top: 0;
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    background: var(--white);
    border: 2px solid var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
}

.timeline-marker i {
    font-size: 0.8rem;
    color: var(--primary);
}

.timeline-content {
    position: relative;
}

.timeline-content::before {
    content: '';
    position: absolute;
    left: -2rem;
    top: 1rem;
    width: 2rem;
    height: 2px;
    background: var(--gray-300);
}

.timeline-item:not(:last-child)::after {
    content: '';
    position: absolute;
    left: 1rem;
    top: 2rem;
    bottom: -2rem;
    width: 2px;
    background: var(--gray-300);
}

.metric-item label {
    font-weight: 500;
    color: var(--text);
    margin-bottom: 0.25rem;
}

.test-result-item {
    padding: 1rem;
    border: 1px solid var(--gray-200);
    border-radius: var(--border-radius-md);
}

.test-result-item h6 {
    margin-bottom: 0.5rem;
    color: var(--text);
}
</style>


{% endblock %}

{% block extra_scripts %}
<script>
function viewRecord(recordId) {
    fetch(`/patient/api/api/records/${recordId}`)
        .then(response => response.json())
        .then(record => {
            const modal = document.getElementById('viewRecordModal');
            const details = document.getElementById('recordDetails');
            
            details.innerHTML = `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6>Thông tin bệnh nhân</h6>
                        <p><strong>Họ tên:</strong> ${record.patient_name || "N/A"}</p>
                        <p><strong>Mã BN:</strong> ${record.patientId}</p>
                        <p><strong>Ngày khám:</strong> ${record.visitDate}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Dấu hiệu sinh tồn</h6>
                        <p><strong>Nhiệt độ:</strong> ${record.vital_signs.temperature}°C</p>
                        <p><strong>Huyết áp:</strong> ${record.vital_signs.blood_pressure.systolic}/${record.vital_signs.blood_pressure.diastolic} mmHg</p>
                        <p><strong>Nhịp tim:</strong> ${record.vital_signs.heart_rate} bpm</p>
                        <p><strong>Nhịp thở:</strong> ${record.vital_signs.respiratoryRate} nhịp/phút</p>
                    </div>
                </div>
                <div class="mb-3">
                    <h6>Triệu chứng</h6>
                    <p>${record.symptoms}</p>
                </div>
                <div class="mb-3">
                    <h6>Chẩn đoán</h6>
                    <p>${record.diagnosis}</p>
                </div>
                <div class="mb-3">
                    <h6>Điều trị</h6>
                    <div class="table-container">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Thuốc</th>
                                    <th>Liều lượng</th>
                                    <th>Tần suất</th>
                                    <th>Thời gian</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${record.treatment.medications.map(med => `
                                    <tr>
                                        <td>${med.name}</td>
                                        <td>${med.dosage}</td>
                                        <td>${med.frequency}</td>
                                        <td>${med.duration}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="mb-3">
                    <h6>Ghi chú</h6>
                    <p>${record.notes}</p>
                </div>
            `;
            
            modal.classList.add('show');
        });
}
// Close modal when clicking outside
document.addEventListener('click', function(event) {
        const modal = document.getElementById('viewRecordModal');
        if (event.target === modal) {
            modal.classList.remove('show');
        }
    });

    // Close modal when clicking close button
    document.querySelector('.btn-close').addEventListener('click', function() {
        document.getElementById('viewRecordModal').classList.remove('show');
    });
    document.getElementById('searchMedicalRecords').addEventListener('input', function (e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('tbody tr');

    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});
</script>
{% endblock %}

