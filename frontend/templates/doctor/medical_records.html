{% extends "base.html" %}

{% block title %}Hồ sơ Bệnh án{% endblock %}

{% block sidebar_menu %}
<div class="nav-item">
    <a href="{{ url_for('doctor.dashboard') }}" class="nav-link">
        <i class="fas fa-home"></i>
        Tổng quan
    </a>
</div>
<div class="nav-item">
    <a href="#" class="nav-link">
        <i class="fas fa-calendar-alt"></i>
        Lịch khám bệnh
    </a>
</div>
<div class="nav-item">
    <a href="{{ url_for('doctor.patients') }}" class="nav-link">
        <i class="fas fa-users"></i>
        Danh sách bệnh nhân
    </a>
</div>
<div class="nav-item">
    <a href="{{ url_for('doctor.medical_records') }}" class="nav-link active">
        <i class="fas fa-file-medical"></i>
        Hồ sơ bệnh án
    </a>
</div>
<div class="nav-item">
    <a href="{{ url_for('doctor.prescriptions') }}" class="nav-link">
        <i class="fas fa-prescription"></i>
        Kê đơn thuốc
    </a>
</div>
{% endblock %}

{% block page_title %}Hồ sơ Bệnh án{% endblock %}

{% block content %}
<!-- Search and Filter -->
<div class="card mb-4">
    <div class="card-body">
        <form class="row g-3" method="GET">
            <div class="col-md-4">
                <label class="form-label">Tìm kiếm bệnh nhân</label>
                <div class="input-group">
                    <input type="text" 
                           class="form-control" 
                           name="search" 
                           placeholder="Nhập mã BN hoặc tên..."
                           value="{{ request.args.get('search', '') }}">
                    <button class="btn btn-primary" type="submit">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label">Từ ngày</label>
                <input type="date" 
                       class="form-control" 
                       name="start_date"
                       value="{{ request.args.get('start_date', '') }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">Đến ngày</label>
                <input type="date" 
                       class="form-control" 
                       name="end_date"
                       value="{{ request.args.get('end_date', '') }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <button type="button" class="btn btn-secondary d-block" onclick="clearFilters()">
                    <i class="fas fa-undo"></i>
                    Đặt lại
                </button>
            </div>
        </form>
    </div>
</div>
{% block extra_styles %}
<style>
    .pagination {
        display: flex;
        justify-content: center; /* Center the pagination links */
        list-style: none; /* Remove the black dot */
        padding: 0; /* Remove default padding */
    }

    .pagination .page-item {
        margin: 0 5px; /* Add spacing between buttons */
    }
</style>
{% endblock %}
<!-- Medical Records List -->
<div class="card">
    <div class="card-body">
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Ngày khám</th>
                        <th>Mã BN</th>
                        <th>Họ và tên</th>
                        <th>Triệu chứng</th>
                        <th>Chẩn đoán</th>
                        <th>Tái khám</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in medical_records %}
                    <tr>
                        <td>{{ record.visitDate }}</td>
                        <td>{{ record.patientId }}</td>
                        <td>{{ record.patient_name }}</td>
                        <td>{{ record.symptoms }}</td>
                        <td>{{ record.diagnosis }}</td>
                        <td>
                            {% if record.followUp.required %}
                            <span class="badge badge-warning">
                                {{ record.followUp.recommendedDate }}
                            </span>
                            {% else %}
                            <span class="badge badge-secondary">Không</span>
                            {% endif %}
                        </td>
                        <td>
                            <button type="button" 
                                    class="btn btn-primary btn-sm" 
                                    onclick="viewRecord('{{ record._id }}')">
                                <i class="fas fa-eye"></i> 
                                Xem
                            </button>
                            <button type="button" 
                                    class="btn btn-secondary btn-sm"
                                    onclick="editRecord('{{ record._id }}')">
                                <i class="fas fa-edit"></i>
                                Sửa
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <nav class="mt-4">
            <ul class="pagination justify-content-center">
                <!-- Previous Page -->
                <li class="page-item {% if not has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('doctor.medical_records', page=page - 1) }}">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
        
                <!-- Page Numbers -->
                {% for p in range(1, total_pages + 1) %}
                <li class="page-item {% if p == page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('doctor.medical_records', page=p) }}">
                        {{ p }}
                    </a>
                </li>
                {% endfor %}
        
                <!-- Next Page -->
                <li class="page-item {% if not has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('doctor.medical_records', page=page + 1) }}">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<!-- View Record Modal -->
<div class="modal" id="viewRecordModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết hồ sơ bệnh án</h5>
                <button type="button" class="btn-close" onclick="closeModal()"></button>
            </div>
            <div class="modal-body" id="recordDetails">
                <!-- Record details will be injected here -->
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    function clearFilters() {
        window.location = "{{ url_for('doctor.medical_records') }}";
    }

    function viewRecord(recordId) {
        fetch(`/api/medical-records/${recordId}`)
            .then(response => response.json())
            .then(record => {
                const modal = document.getElementById('viewRecordModal');
                const details = document.getElementById('recordDetails');
                
                details.innerHTML = `
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6>Thông tin bệnh nhân</h6>
                            <p><strong>Họ tên:</strong> ${record.patient_name || "N/A"}</p>
                            <p><strong>Mã BN:</strong> ${record.patient_id}</p>
                            <p><strong>Ngày khám:</strong> ${record.visit_date}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Dấu hiệu sinh tồn</h6>
                            <p><strong>Nhiệt độ:</strong> ${record.vital_signs.temperature}°C</p>
                            <p><strong>Huyết áp:</strong> ${record.vital_signs.blood_pressure.systolic}/${record.vital_signs.blood_pressure.diastolic} mmHg</p>
                            <p><strong>Nhịp tim:</strong> ${record.vital_signs.heart_rate} bpm</p>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6>Triệu chứng</h6>
                        <p>${record.symptoms.join(', ')}</p>
                    </div>
                    <div class="mb-3">
                        <h6>Chẩn đoán</h6>
                        <p>${record.diagnosis.join(', ')}</p>
                    </div>
                    <div class="mb-3">
                        <h6>Điều trị</h6>
                        <div class="table-container">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Thuốc</th>
                                        <th>Liều lượng</th>
                                        <th>Tần suất</th>
                                        <th>Thời gian</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${record.treatment.medications.map(med => `
                                        <tr>
                                            <td>${med.name || "N/A"}</td>
                                            <td>${med.dosage}</td>
                                            <td>${med.frequency}</td>
                                            <td>${med.duration}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6>Ghi chú</h6>
                        <p>${record.notes}</p>
                    </div>
                `;
                
                modal.classList.add('show');
            });
    }

    function editRecord(recordId) {
        window.location = `/doctor/medical-records/${recordId}/edit`;
    }

    // Close modal when clicking outside
    document.addEventListener('click', function(event) {
        const modal = document.getElementById('viewRecordModal');
        if (event.target === modal) {
            modal.classList.remove('show');
        }
    });

    // Close modal when clicking close button
    document.querySelector('.btn-close').addEventListener('click', function() {
        document.getElementById('viewRecordModal').classList.remove('show');
    });
</script>
{% endblock %}