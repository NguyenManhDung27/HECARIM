{% extends "base.html" %}

{% block title %}Bảng điều khiển Bác sĩ{% endblock %}

{% block sidebar_menu %}
<div class="nav-item">
    <a href="{{ url_for('doctor.dashboard') }}" class="nav-link {% if request.endpoint == 'doctor.dashboard' %}active{% endif %}">
        <i class="fas fa-home"></i>
        Tổng quan
    </a>
</div>
<div class="nav-item">
    <a href="{{ url_for('doctor.medical_records') }}" class="nav-link {% if request.endpoint == 'doctor.medical_records' %}active{% endif %}">
        <i class="fas fa-file-medical"></i>
        Hồ sơ bệnh án
    </a>
</div>
<div class="nav-item">
    <a href="{{ url_for('doctor.prescriptions') }}" class="nav-link {% if request.endpoint == 'doctor.prescriptions' %}active{% endif %}">
        <i class="fas fa-prescription"></i>
        Kê đơn thuốc
    </a>
</div>
<div class="nav-item">
    <a href="{{ url_for('doctor.patients') }}" class="nav-link {% if request.endpoint == 'doctor.patients' %}active{% endif %}">
        <i class="fas fa-users"></i>
        Danh sách bệnh nhân
    </a>
</div>
<div class="nav-item">
    <a href="{{ url_for('doctor.profile') }}" class="nav-link {% if request.endpoint == 'doctor.profile' %}active{% endif %}">
        <i class="fas fa-user"></i>
        Thông tin cá nhân
    </a>
</div>
{% endblock %}

{% block page_title %}Tổng quan{% endblock %}

{% block content %}
<!-- Today's Stats -->
<div class="row">
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="stats-icon">
                    <i class="fas fa-calendar fa-2x text-primary"></i>
                </div>
                <div class="stats-info">
                    <p class="stats-label">Lịch hẹn hôm nay</p>
                    <h2 class="stats-value mb-0">{{ stats.total_appointments }}</h2>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="stats-icon">
                    <i class="fas fa-check-circle fa-2x text-success"></i>
                </div>
                <div class="stats-info">
                    <p class="stats-label">Đã khám</p>
                    <h2 class="stats-value mb-0">{{ stats.completed_appointments }}</h2>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="stats-icon">
                    <i class="fas fa-clock fa-2x text-warning"></i>
                </div>
                <div class="stats-info">
                    <p class="stats-label">Đang chờ</p>
                    <h2 class="stats-value mb-0">{{ stats.waiting_appointments }}</h2>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body">
                <div class="stats-icon">
                    <i class="fas fa-notes-medical fa-2x text-info"></i>
                </div>
                <div class="stats-info">
                    <p class="stats-label">Đơn thuốc</p>
                    <h2 class="stats-value mb-0">{{ stats.prescriptions }}</h2>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Today's Appointments -->
<div class="card my-4">
    <div class="card-header">
        <h2 class="card-title mb-0">Lịch khám hôm nay</h2>
    </div>
    <div class="card-body">
        <div class="table-container">
            <table class="table" id="appointmentsTable">
                <thead>
                    <tr>
                        <th>Giờ</th>
                        <th>Mã BN</th>
                        <th>Họ và tên</th>
                        <th>Loại khám</th>
                        <th>Trạng thái</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    {% for appointment in appointments %}
                    <tr>
                        <td>{{ appointment.time }}</td>
                        <td>{{ appointment.patient_id }}</td>
                        <td>{{ appointment.patient_name }}</td>
                        <td>{{ appointment.type }}</td>
                        <td>
                            <span class="badge badge-{{ appointment.status_class }}">
                                {{ appointment.status }}
                            </span>
                        </td>
                        <td>
                            {% if appointment.status != 'completed' %}
                            <a href="#" class="btn btn-primary btn-sm">
                                <i class="fas fa-stethoscope"></i>
                                Khám bệnh
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
 </div>

<!-- Monitored Patients -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title mb-0">Bệnh nhân cần theo dõi</h2>
    </div>
    <div class="card-body">
        {% if monitored_patients %}
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Mã BN</th>
                        <th>Họ và tên</th>
                        <th>Chẩn đoán</th>
                        <th>Lần khám gần nhất</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    {% for patient in monitored_patients %}
                    <tr>
                        <td>{{ patient.patientId }}</td>
                        <td>{{ patient.personalInfo.fullName }}</td>
                        <td>{{ patient.diagnosis }}</td>
                        <td>{{ patient.lastVisit.strftime('%d/%m/%Y') if patient.lastVisit else 'Chưa có' }}</td>
                        <td>
                            <a href="#" 
                               class="btn btn-secondary btn-sm">
                                <i class="fas fa-eye"></i>
                                Chi tiết
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-center text-muted">Không có bệnh nhân nào cần theo dõi</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Function to update dashboard data
    function updateDashboard() {
    console.log("Updating dashboard data...");
    fetch('/doctor/api/appointments/today')
        .then(response => response.json())
        .then(data => {
            console.log("Dữ liệu từ API:", data); // Kiểm tra dữ liệu trả về

            // Update appointments table
            const tbody = document.querySelector('#appointmentsTable tbody');
            if (tbody) {
                if(data.length > 0) {
                tbody.innerHTML = data.map(appointment => `
                    <tr>
                        <td>${appointment.time}</td>
                        <td>${appointment.patient_id}</td>
                        <td>${appointment.patient_name}</td>
                        <td>${appointment.type}</td>
                        <td>
                            <span class="badge badge-${appointment.status_class}">
                                ${appointment.status}
                            </span>
                        </td>
                        <td>
                            ${appointment.status !== 'completed' ? `
                            <a href="{{ url_for('doctor.examination', patient_id='') }}${appointment.patient_id}"
                               class="btn btn-primary btn-sm">
                                <i class="fas fa-stethoscope"></i>
                                Khám bệnh
                            </a>` : ''}
                        </td>
                    </tr>
                `).join('');
                }
                else{
                    tbody.innerHTML = `<p class="text-center text-muted">Không có lịch hẹn nào cho hôm nay</p>`;
                }
            } else {
                console.error('Phần tử #appointmentsTable không tồn tại.');
            }
        })
        .catch(error => {
            console.error('Lỗi khi gọi API:', error);
        });
}
document.addEventListener('DOMContentLoaded', () => {
    // Gọi hàm ngay khi trang được tải
    updateDashboard();

    // Update dashboard every 30 seconds
    setInterval(updateDashboard, 30000);
});
</script>
{% endblock %}