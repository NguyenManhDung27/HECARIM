{% extends "base.html" %}

{% block title %}Danh sách Bệnh nhân{% endblock %}

{% block sidebar_menu %}
<div class="nav-item">
    <a href="{{ url_for('doctor.dashboard') }}" class="nav-link">
        <i class="fas fa-home"></i>
        Tổng quan
    </a>
</div>
<div class="nav-item">
    <a href="#" class="nav-link">
        <i class="fas fa-calendar-alt"></i>
        Lịch khám bệnh
    </a>
</div>
<div class="nav-item">
    <a href="#" class="nav-link active">
        <i class="fas fa-users"></i>
        Danh sách bệnh nhân
    </a>
</div>
<div class="nav-item">
    <a href="#" class="nav-link">
        <i class="fas fa-file-medical"></i>
        Hồ sơ bệnh án
    </a>
</div>
<div class="nav-item">
    <a href="{{ url_for('doctor.prescriptions') }}" class="nav-link">
        <i class="fas fa-prescription"></i>
        Kê đơn thuốc
    </a>
</div>
{% endblock %}

{% block page_title %}Danh sách Bệnh nhân{% endblock %}

{% block content %}
<!-- Search and Filter -->
<div class="card mb-4">
    <div class="card-body">
        <form class="row g-3" method="GET">
            <div class="col-md-4">
                <div class="input-group">
                    <input type="text" 
                           class="form-control" 
                           name="search" 
                           placeholder="Tìm theo mã BN, tên, số điện thoại..."
                           value="{{ request.args.get('search', '') }}">
                    <button class="btn btn-primary" type="submit">
                        <i class="fas fa-search"></i>
                        Tìm kiếm
                    </button>
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select" name="blood_type">
                    <option value="">Nhóm máu</option>
                    <option value="A+" {% if request.args.get('blood_type') == 'A+' %}selected{% endif %}>A+</option>
                    <option value="A-" {% if request.args.get('blood_type') == 'A-' %}selected{% endif %}>A-</option>
                    <option value="B+" {% if request.args.get('blood_type') == 'B+' %}selected{% endif %}>B+</option>
                    <option value="B-" {% if request.args.get('blood_type') == 'B-' %}selected{% endif %}>B-</option>
                    <option value="O+" {% if request.args.get('blood_type') == 'O+' %}selected{% endif %}>O+</option>
                    <option value="O-" {% if request.args.get('blood_type') == 'O-' %}selected{% endif %}>O-</option>
                    <option value="AB+" {% if request.args.get('blood_type') == 'AB+' %}selected{% endif %}>AB+</option>
                    <option value="AB-" {% if request.args.get('blood_type') == 'AB-' %}selected{% endif %}>AB-</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" name="gender">
                    <option value="">Giới tính</option>
                    <option value="Nam" {% if request.args.get('gender') == 'Nam' %}selected{% endif %}>Nam</option>
                    <option value="Nữ" {% if request.args.get('gender') == 'Nữ' %}selected{% endif %}>Nữ</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-secondary w-100" onclick="clearFilters()">
                    <i class="fas fa-undo"></i>
                    Đặt lại
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Patients List -->
<div class="card">
    <div class="card-body">
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Mã BN</th>
                        <th>Họ và tên</th>
                        <th>Giới tính</th>
                        <th>Ngày sinh</th>
                        <th>Số điện thoại</th>
                        <th>Lần khám gần nhất</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    {% for patient in patients %}
                    <tr>
                        <td>{{ patient.patientId }}</td>
                        <td>{{ patient.personalInfo.fullName }}</td>
                        <td>{{ patient.personalInfo.gender }}</td>
                        <td>{{ patient.personalInfo.dateOfBirth.strftime('%d/%m/%Y') }}</td>
                        <td>{{ patient.personalInfo.phone }}</td>
                        <td>
                            {% if patient.last_visit %}
                                {{ patient.last_visit.strftime('%d/%m/%Y') }}
                            {% else %}
                            <span class="text-muted">Chưa có</span>
                            {% endif %}
                        </td>
                        <td>
                            <button type="button" 
                                    class="btn btn-primary btn-sm"
                                    onclick="viewPatient('{{ patient._id }}')">
                                <i class="fas fa-eye"></i>
                                Chi tiết
                            </button>
                            <button type="button" 
                                    class="btn btn-secondary btn-sm"
                                    onclick="viewHistory('{{ patient._id }}')">
                                <i class="fas fa-history"></i>
                                Lịch sử
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <nav class="mt-3">
            <ul class="pagination justify-content-center">
                <li class="page-item {% if not has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('doctor.patients', page=page-1) }}">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
                {% for p in range(1, total_pages + 1) %}
                <li class="page-item {% if p == page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('doctor.patients', page=p) }}">
                        {{ p }}
                    </a>
                </li>
                {% endfor %}
                <li class="page-item {% if not has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('doctor.patients', page=page+1) }}">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<!-- Patient Details Modal -->
<div class="modal" id="patientModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thông tin Bệnh nhân</h5>
                <button type="button" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="patientDetails"></div>
            </div>
        </div>
    </div>
</div>

<!-- Patient History Modal -->
<div class="modal" id="historyModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Lịch sử Khám bệnh</h5>
                <button type="button" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="patientHistory"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function clearFilters() {
        window.location = "{{ url_for('doctor.patients') }}";
    }

    function viewPatient(patientId) {
        console.log('Fetching patient details for ID:', patientId);
        fetch(`/doctor/api/patients/${patientId}`)
            .then(response => response.json())
            .then(patient => {
                const details = document.getElementById('patientDetails');
                details.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Thông tin cá nhân</h6>
                            <p><strong>Họ và tên:</strong> ${patient.personalInfo.fullName}</p>
                            <p><strong>Mã BN:</strong> ${patient.patientId}</p>
                            <p><strong>Giới tính:</strong> ${patient.personalInfo.gender}</p>
                            <p><strong>Ngày sinh:</strong> ${new Date(patient.personalInfo.dateOfBirth).toLocaleDateString()}</p>
                            <p><strong>CCCD/CMND:</strong> ${patient.personalInfo.idNumber}</p>
                            <p><strong>Địa chỉ:</strong> ${patient.personalInfo.address}</p>
                            <p><strong>Điện thoại:</strong> ${patient.personalInfo.phone}</p>
                            <p><strong>Email:</strong> ${patient.personalInfo.email}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Thông tin sức khỏe</h6>
                            <p><strong>Nhóm máu:</strong> ${patient.healthInfo.bloodType}</p>
                            <p><strong>Chiều cao:</strong> ${patient.healthInfo.height} cm</p>
                            <p><strong>Cân nặng:</strong> ${patient.healthInfo.weight} kg</p>
                            <p><strong>Dị ứng:</strong> ${patient.healthInfo.allergies.join(', ') || 'Không'}</p>
                            <p><strong>Bệnh mãn tính:</strong> ${patient.healthInfo.chronicDiseases.join(', ') || 'Không'}</p>
                        </div>
                    </div>
                `;
                
                document.getElementById('patientModal').classList.add('show');
            });
    }

    function viewHistory(patientId) {
        fetch(`/api/patients/${patientId}/history`)
            .then(response => response.json())
            .then(history => {
                const historyEl = document.getElementById('patientHistory');
                
                if (history.length === 0) {
                    historyEl.innerHTML = '<p class="text-center text-muted">Chưa có lịch sử khám bệnh</p>';
                } else {
                    historyEl.innerHTML = history.map(visit => `
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">Ngày khám: ${new Date(visit.diagnosisDate).toLocaleDateString()}</h6>
                                    <span class="text-muted">Bác sĩ: ${visit.doctorName}</span>
                                </div>
                                <p><strong>Triệu chứng:</strong> ${visit.symptoms.join(', ')}</p>
                                <p><strong>Chẩn đoán:</strong> ${visit.diagnosis}</p>
                                <p><strong>Điều trị:</strong> ${visit.treatment}</p>
                                <p><strong>Ghi chú:</strong> ${visit.notes || 'Không có'}</p>
                            </div>
                        </div>
                    `).join('');
                }
                
                document.getElementById('historyModal').classList.add('show');
            });
    }

    // Close modals
    document.querySelectorAll('.modal-close').forEach(button => {
        button.addEventListener('click', function() {
            this.closest('.modal').classList.remove('show');
        });
    });

    // Close modal when clicking outside
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.classList.remove('show');
        }
    });
</script>
<style>
    .pagination {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-wrap: nowrap; /* Đảm bảo các phần tử nằm trên cùng một dòng */
        list-style: none; /* Loại bỏ dấu chấm đen nếu có */
        padding: 0; /* Loại bỏ khoảng cách thừa */
        margin: 0; /* Loại bỏ khoảng cách thừa */
    }

    .pagination .page-item {
        margin: 0 5px; /* Thêm khoảng cách giữa các nút */
    }
</style>
{% endblock %}