{% extends "base_dashboard.html" %}

{% block title %}Qu·∫£n l√Ω l·ªãch h·∫πn{% endblock %}

{% block page_title %}Qu·∫£n l√Ω l·ªãch h·∫πn{% endblock %}

{% block page_actions %}
<a href="/receptionist/appointments/new" class="btn btn-primary">
    + ƒê·∫∑t l·ªãch h·∫πn m·ªõi
</a>
{% endblock %}

{% block extra_css %}
<style>
    /* Filters */
    .filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
        padding: var(--spacing-lg);
        background: var(--white);
        border-radius: var(--border-radius);
        box-shadow: 0 2px 8px rgba(44, 107, 255, 0.1);
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
    }

    .form-group label {
        font-family: 'Montserrat', sans-serif;
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text);
    }

    .form-group select,
    .form-group input[type="date"] {
        padding: var(--spacing-sm) var(--spacing-md);
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius);
        font-size: 0.95rem;
        color: var(--text);
        transition: all 0.3s ease;
    }

    .form-group select:focus,
    .form-group input[type="date"]:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(44, 107, 255, 0.1);
    }

    /* Search Box */
    .search-box {
        margin-bottom: var(--spacing-lg);
        position: relative;
    }

    .search-box input {
        width: 100%;
        padding: var(--spacing-md) var(--spacing-lg);
        padding-left: 3rem;
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius);
        font-size: 0.95rem;
        transition: all 0.3s ease;
    }

    .search-box input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(44, 107, 255, 0.1);
    }

    .search-box::before {
        content: 'üîç';
        position: absolute;
        left: var(--spacing-md);
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.2rem;
        color: var(--text-light);
    }

    /* Status Badges */
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: var(--spacing-xs) var(--spacing-md);
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
        line-height: 1;
    }

    .status-scheduled {
        background: linear-gradient(45deg, #fef9c3, #fef08a);
        color: #854d0e;
        box-shadow: 0 2px 4px rgba(133, 77, 14, 0.1);
    }
    
    .status-confirmed {
        background: linear-gradient(45deg, #dcfce7, #86efac);
        color: #166534;
        box-shadow: 0 2px 4px rgba(22, 101, 52, 0.1);
    }

    .status-checked-in {
        background: linear-gradient(45deg, #e0f2fe, #7dd3fc);
        color: #075985;
        box-shadow: 0 2px 4px rgba(7, 89, 133, 0.1);
    }

    .status-in-progress {
        background: linear-gradient(45deg, #ddd6fe, #c4b5fd);
        color: #5b21b6;
        box-shadow: 0 2px 4px rgba(91, 33, 182, 0.1);
    }

    .status-completed {
        background: linear-gradient(45deg, #bbf7d0, #86efac);
        color: #15803d;
        box-shadow: 0 2px 4px rgba(21, 128, 61, 0.1);
    }

    .status-cancelled {
        background: linear-gradient(45deg, #fee2e2, #fca5a5);
        color: #991b1b;
        box-shadow: 0 2px 4px rgba(153, 27, 27, 0.1);
    }

    .status-missed {
        background: linear-gradient(45deg, #fecaca, #f87171);
        color: #991b1b;
        box-shadow: 0 2px 4px rgba(153, 27, 27, 0.1);
    }

    /* Action Buttons */
    .actions {
        display: flex;
        gap: var(--spacing-xs);
    }

    .actions button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border: none;
        background: var(--white);
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1.1rem;
    }

    .actions button:hover {
        background: rgba(44, 107, 255, 0.1);
        color: var(--primary);
        transform: translateY(-2px);
    }

    /* Table */
    .table-container {
        background: var(--white);
        border-radius: var(--border-radius);
        box-shadow: 0 4px 12px rgba(44, 107, 255, 0.1);
        overflow: hidden;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th {
        background: #f8fafc;
        padding: var(--spacing-md) var(--spacing-lg);
        text-align: left;
        font-family: 'Montserrat', sans-serif;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text);
        border-bottom: 2px solid var(--gray-200);
    }

    .data-table td {
        padding: var(--spacing-md) var(--spacing-lg);
        font-size: 0.95rem;
        border-bottom: 1px solid var(--gray-200);
        vertical-align: middle;
    }

    .data-table tr:hover {
        background: rgba(44, 107, 255, 0.02);
    }

    /* Pagination */
    .pagination {
        display: flex;
        justify-content: center;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-xl);
    }

    .pagination button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 40px;
        height: 40px;
        padding: 0 var(--spacing-md);
        border: 1px solid var(--gray-200);
        background: var(--white);
        border-radius: var(--border-radius);
        font-family: 'Inter', sans-serif;
        font-size: 0.95rem;
        color: var(--text);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .pagination button:hover:not(:disabled) {
        border-color: var(--primary);
        color: var(--primary);
        transform: translateY(-2px);
    }

    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .pagination button.active {
        background: linear-gradient(45deg, var(--primary), var(--secondary));
        color: var(--white);
        border: none;
        box-shadow: 0 4px 12px rgba(44, 107, 255, 0.2);
    }

    /* Modal */
    #appointmentModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(17, 24, 39, 0.7);
        z-index: 1000;
        overflow-y: auto;
        padding: var(--spacing-lg);
    }

    .modal-content {
        position: relative;
        width: 90%;
        max-width: 600px;
        margin: var(--spacing-xl) auto;
        background: var(--white);
        border-radius: var(--border-radius-lg);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .modal-header {
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--gray-200);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: linear-gradient(to right, var(--white), #f8fafc);
    }

    .modal-header h3 {
        font-family: 'Montserrat', sans-serif;
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text);
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        color: var(--text-light);
        font-size: 1.5rem;
        cursor: pointer;
        padding: var(--spacing-sm);
        border-radius: var(--border-radius);
        transition: all 0.3s ease;
    }

    .modal-close:hover {
        background: rgba(44, 107, 255, 0.1);
        color: var(--primary);
    }

    .modal-body {
        padding: var(--spacing-lg);
    }

    #appointmentDetails p {
        margin: var(--spacing-xs) 0;
        display: flex;
        gap: var(--spacing-md);
        font-size: 0.95rem;
    }

    #appointmentDetails strong {
        color: var(--text-light);
        min-width: 120px;
    }

    .modal-footer {
        padding: var(--spacing-md) var(--spacing-lg);
        border-top: 1px solid var(--gray-200);
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: var(--spacing-md);
        background: #f8fafc;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <!-- Filters -->
    <div class="filters">
        <div class="form-group">
            <label for="dateFilter">Ng√†y</label>
            <input type="date" id="dateFilter" onchange="applyFilters()">
        </div>
        <div class="form-group">
            <label for="departmentFilter">Khoa</label>
            <select id="departmentFilter" onchange="applyFilters()">
                <option value="">T·∫•t c·∫£</option>
                {% for dept in departments %}
                <option value="{{ dept }}">{{ dept }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="statusFilter">Tr·∫°ng th√°i</label>
            <select id="statusFilter" onchange="applyFilters()">
                <option value="">T·∫•t c·∫£</option>
                <option value="scheduled">ƒê√£ ƒë·∫∑t l·ªãch</option>
                <option value="confirmed">ƒê√£ x√°c nh·∫≠n</option>
                <option value="checked_in">ƒê√£ ti·∫øp nh·∫≠n</option>
                <option value="in_progress">ƒêang kh√°m</option>
                <option value="completed">ƒê√£ ho√†n th√†nh</option>
                <option value="cancelled">ƒê√£ h·ªßy</option>
                <option value="missed">V·∫Øng m·∫∑t</option>
            </select>
        </div>
    </div>

    <!-- Search -->
    <div class="search-box">
        <input type="text" 
               id="searchInput" 
               placeholder="T√¨m ki·∫øm theo m√£ BN, t√™n b·ªánh nh√¢n ho·∫∑c b√°c sƒ©..."
               onkeyup="debounceSearch()">
    </div>

    <!-- Appointments Table -->
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Ng√†y gi·ªù</th>
                    <th>M√£ BN</th>
                    <th>T√™n b·ªánh nh√¢n</th>
                    <th>B√°c sƒ©</th>
                    <th>Khoa</th>
                    <th>Lo·∫°i kh√°m</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Thao t√°c</th>
                </tr>
            </thead>
            <tbody id="appointmentsTableBody">
                <!-- Will be populated by JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="pagination" id="pagination">
        <!-- Will be populated by JavaScript -->
    </div>
</div>

<!-- Appointment Details Modal -->
<div id="appointmentModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Chi ti·∫øt l·ªãch h·∫πn</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="appointmentDetails">
                <!-- Will be populated by JavaScript -->
            </div>
            <div class="form-group" style="margin-top: 1rem;">
                <label for="statusUpdate">C·∫≠p nh·∫≠t tr·∫°ng th√°i</label>
                <select id="statusUpdate">
                    <option value="confirmed">ƒê√£ x√°c nh·∫≠n</option>
                    <option value="checked_in">ƒê√£ ti·∫øp nh·∫≠n</option>
                    <option value="cancelled">H·ªßy l·ªãch h·∫πn</option>
                    <option value="missed">V·∫Øng m·∫∑t</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">ƒê√≥ng</button>
            <button class="btn btn-primary" onclick="updateAppointmentStatus()">
                C·∫≠p nh·∫≠t
                <span class="loading"></span>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentPage = 1;
let totalPages = 1;
let currentAppointment = null;
let searchDebounceTimer;

const PAGE_SIZE = 10;

// Initial load
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    document.getElementById('dateFilter').value = today.toISOString().split('T')[0];
    loadAppointments();
});

function debounceSearch() {
    clearTimeout(searchDebounceTimer);
    searchDebounceTimer = setTimeout(() => {
        loadAppointments();
    }, 300);
}

async function loadAppointments() {
    const date = document.getElementById('dateFilter').value;
    const department = document.getElementById('departmentFilter').value;
    const status = document.getElementById('statusFilter').value;
    const search = document.getElementById('searchInput').value;

    try {
        const response = await fetch(`/receptionist/api/appointments?` + new URLSearchParams({
            date,
            department,
            status,
            search,
            page: currentPage,
            page_size: PAGE_SIZE
        }));

        if (!response.ok) throw new Error('Failed to load appointments');

        const data = await response.json();
        renderAppointments(data.appointments);
        renderPagination(data.total_pages);
    } catch (error) {
        console.error('Error loading appointments:', error);
        alert('C√≥ l·ªói khi t·∫£i danh s√°ch l·ªãch h·∫πn');
    }
}

function renderAppointments(appointments) {
    const tbody = document.getElementById('appointmentsTableBody');
    tbody.innerHTML = '';

    appointments.forEach(appt => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${formatDateTime(appt.timeSlot.start)}</td>
            <td>${appt.patientId}</td>
            <td>${appt.patientName}</td>
            <td>${appt.doctorName}</td>
            <td>${appt.department}</td>
            <td>${formatAppointmentType(appt.type)}</td>
            <td>
                <span class="status-badge status-${appt.status}">
                    ${formatStatus(appt.status)}
                </span>
            </td>
            <td class="actions">
                <button onclick="viewAppointment('${appt.id}')" title="Xem chi ti·∫øt">
                    üëÅÔ∏è
                </button>
                ${appt.status === 'scheduled' ? `
                    <button onclick="confirmAppointment('${appt.id}')" title="X√°c nh·∫≠n">
                        ‚úì
                    </button>
                ` : ''}
                ${['scheduled', 'confirmed'].includes(appt.status) ? `
                    <button onclick="cancelAppointment('${appt.id}')" title="H·ªßy l·ªãch h·∫πn">
                        ‚ùå
                    </button>
                ` : ''}
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function renderPagination(totalPages) {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';

    // Previous button
    const prevButton = document.createElement('button');
    prevButton.textContent = '‚Üê';
    prevButton.disabled = currentPage === 1;
    prevButton.onclick = () => {
        if (currentPage > 1) {
            currentPage--;
            loadAppointments();
        }
    };
    pagination.appendChild(prevButton);

    // Page buttons
    for (let i = 1; i <= totalPages; i++) {
        const button = document.createElement('button');
        button.textContent = i;
        button.classList.toggle('active', i === currentPage);
        button.onclick = () => {
            currentPage = i;
            loadAppointments();
        };
        pagination.appendChild(button);
    }

    // Next button
    const nextButton = document.createElement('button');
    nextButton.textContent = '‚Üí';
    nextButton.disabled = currentPage === totalPages;
    nextButton.onclick = () => {
        if (currentPage < totalPages) {
            currentPage++;
            loadAppointments();
        }
    };
    pagination.appendChild(nextButton);
}

async function viewAppointment(id) {
    try {
        const response = await fetch(`/receptionist/api/appointments/${id}`);
        if (!response.ok) throw new Error('Failed to load appointment details');

        const appointment = await response.json();
        currentAppointment = appointment;

        const details = document.getElementById('appointmentDetails');
        details.innerHTML = `
            <p><strong>M√£ l·ªãch h·∫πn:</strong> ${appointment.id}</p>
            <p><strong>B·ªánh nh√¢n:</strong> ${appointment.patientName}</p>
            <p><strong>B√°c sƒ©:</strong> ${appointment.doctorName}</p>
            <p><strong>Khoa:</strong> ${appointment.department}</p>
            <p><strong>Ng√†y gi·ªù:</strong> ${formatDateTime(appointment.timeSlot.start)}</p>
            <p><strong>Lo·∫°i kh√°m:</strong> ${formatAppointmentType(appointment.type)}</p>
            <p><strong>L√Ω do kh√°m:</strong> ${appointment.reason || 'Kh√¥ng c√≥'}</p>
            <p><strong>Ghi ch√∫:</strong> ${appointment.notes || 'Kh√¥ng c√≥'}</p>
        `;

        document.getElementById('statusUpdate').value = appointment.status;
        document.getElementById('appointmentModal').style.display = 'block';
    } catch (error) {
        console.error('Error loading appointment details:', error);
        alert('C√≥ l·ªói khi t·∫£i chi ti·∫øt l·ªãch h·∫πn');
    }
}

async function updateAppointmentStatus() {
    if (!currentAppointment) return;

    const newStatus = document.getElementById('statusUpdate').value;
    const button = document.querySelector('.modal-footer .btn-primary');
    const loading = button.querySelector('.loading');

    try {
        button.disabled = true;
        loading.style.display = 'inline-block';

        const response = await fetch(`/receptionist/api/appointments/${currentAppointment.id}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: newStatus })
        });

        if (!response.ok) throw new Error('Failed to update status');

        closeModal();
        loadAppointments();
    } catch (error) {
        console.error('Error updating appointment status:', error);
        alert('C√≥ l·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i');
    } finally {
        button.disabled = false;
        loading.style.display = 'none';
    }
}

function closeModal() {
    document.getElementById('appointmentModal').style.display = 'none';
    currentAppointment = null;
}

function formatDateTime(datetime) {
    return new Date(datetime).toLocaleDateString('vi-VN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function formatAppointmentType(type) {
    const types = {
        regular: 'Kh√°m th∆∞·ªùng',
        follow_up: 'T√°i kh√°m',
        emergency: 'C·∫•p c·ª©u'
    };
    return types[type] || type;
}

function formatStatus(status) {
    const statuses = {
        scheduled: 'ƒê√£ ƒë·∫∑t l·ªãch',
        confirmed: 'ƒê√£ x√°c nh·∫≠n',
        checked_in: 'ƒê√£ ti·∫øp nh·∫≠n',
        in_progress: 'ƒêang kh√°m',
        completed: 'ƒê√£ ho√†n th√†nh',
        cancelled: 'ƒê√£ h·ªßy',
        missed: 'V·∫Øng m·∫∑t'
    };
    return statuses[status] || status;
}

// Event listeners for filters
function applyFilters() {
    currentPage = 1;
    loadAppointments();
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('appointmentModal');
    if (event.target === modal) {
        closeModal();
    }
}
</script>
{% endblock %}