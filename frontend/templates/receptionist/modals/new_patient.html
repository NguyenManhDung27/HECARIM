<!-- New Patient Modal -->
<div class="modal" id="newPatientModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Đăng ký bệnh nhân mới</h5>
                <button type="button" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="patientForm">
                    <!-- Personal Information -->
                    <h6 class="mb-3">Thông tin cá nhân</h6>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Họ và tên</label>
                                <input type="text" 
                                       class="form-control" 
                                       name="fullName" 
                                       required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Giới tính</label>
                                <select class="form-select" name="gender" required>
                                    <option value="">Chọn giới tính...</option>
                                    <option value="Nam">Nam</option>
                                    <option value="Nữ">Nữ</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Ngày sinh</label>
                                <input type="date" 
                                       class="form-control" 
                                       name="dateOfBirth" 
                                       required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">CCCD/CMND</label>
                                <input type="text" 
                                       class="form-control" 
                                       name="idNumber" 
                                       required>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-group mb-3">
                                <label class="form-label">Địa chỉ</label>
                                <input type="text" 
                                       class="form-control" 
                                       name="address" 
                                       required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Số điện thoại</label>
                                <input type="tel" 
                                       class="form-control" 
                                       name="phone" 
                                       required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" 
                                       class="form-control" 
                                       name="email">
                            </div>
                        </div>
                    </div>

                    <!-- Emergency Contact -->
                    <h6 class="mb-3">Thông tin liên hệ khẩn cấp</h6>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Họ tên người liên hệ</label>
                                <input type="text" 
                                       class="form-control" 
                                       name="emergencyContact.name" 
                                       required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Mối quan hệ</label>
                                <input type="text" 
                                       class="form-control" 
                                       name="emergencyContact.relationship" 
                                       required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Số điện thoại</label>
                                <input type="tel" 
                                       class="form-control" 
                                       name="emergencyContact.phone" 
                                       required>
                            </div>
                        </div>
                    </div>

                    <!-- Health Information -->
                    <h6 class="mb-3">Thông tin sức khỏe</h6>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Nhóm máu</label>
                                <select class="form-select" name="bloodType">
                                    <option value="">Chọn nhóm máu...</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group mb-3">
                                <label class="form-label">Chiều cao (cm)</label>
                                <input type="number" 
                                       class="form-control" 
                                       name="height">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group mb-3">
                                <label class="form-label">Cân nặng (kg)</label>
                                <input type="number" 
                                       class="form-control" 
                                       name="weight">
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-group mb-3">
                                <label class="form-label">Dị ứng</label>
                                <input type="text" 
                                       class="form-control" 
                                       name="allergies" 
                                       placeholder="Các loại dị ứng, phân cách bằng dấu phẩy">
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-group mb-3">
                                <label class="form-label">Bệnh mãn tính</label>
                                <input type="text" 
                                       class="form-control" 
                                       name="chronicDiseases" 
                                       placeholder="Các bệnh mãn tính, phân cách bằng dấu phẩy">
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-group mb-3">
                                <label class="form-label">Tiền sử bệnh gia đình</label>
                                <textarea class="form-control" 
                                          name="familyMedicalHistory" 
                                          rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Insurance Information -->
                    <h6 class="mb-3">Thông tin bảo hiểm</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Công ty bảo hiểm</label>
                                <input type="text" 
                                       class="form-control" 
                                       name="insurance.provider">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Số thẻ bảo hiểm</label>
                                <input type="text" 
                                       class="form-control" 
                                       name="insurance.policyNumber">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Ngày hết hạn</label>
                                <input type="date" 
                                       class="form-control" 
                                       name="insurance.expiryDate">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('newPatientModal')">
                    Hủy
                </button>
                <button type="button" class="btn btn-primary" onclick="savePatient()">
                    Đăng ký
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function savePatient() {
        const form = document.getElementById('patientForm');
        const formData = new FormData(form);
        const data = {
            personalInfo: {},
            healthInfo: {},
            insurance: {},
            emergencyContact: {}
        };

        // Process form data into structured object
        formData.forEach((value, key) => {
            if (key.includes('.')) {
                const [section, field] = key.split('.');
                if (section === 'emergencyContact') {
                    data.emergencyContact[field] = value;
                } else if (section === 'insurance') {
                    data.insurance[field] = value;
                }
            } else {
                switch (key) {
                    case 'fullName':
                    case 'gender':
                    case 'dateOfBirth':
                    case 'idNumber':
                    case 'address':
                    case 'phone':
                    case 'email':
                        data.personalInfo[key] = value;
                        break;
                    case 'bloodType':
                    case 'height':
                    case 'weight':
                    case 'familyMedicalHistory':
                        data.healthInfo[key] = value;
                        break;
                    case 'allergies':
                    case 'chronicDiseases':
                        data.healthInfo[key] = value ? value.split(',').map(item => item.trim()) : [];
                        break;
                }
            }
        });

        fetch('/api/patients', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                closeModal('newPatientModal');
                window.location.reload();
            } else {
                alert('Có lỗi xảy ra khi đăng ký bệnh nhân');
            }
        });
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('show');
    }
</script>